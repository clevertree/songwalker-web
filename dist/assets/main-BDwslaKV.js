import{e as W,R as re,K as ge,a as J,l as N,M as be}from"./monaco-editor-DrfwNogv.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();function Q(a){const e=_(a,c.__wbindgen_malloc,c.__wbindgen_realloc),t=x,n=c.compile_song(e,t);if(n[2])throw S(n[1]);return S(n[0])}function ye(){let a,e;try{const t=c.core_version();return a=t[0],e=t[1],U(t[0],t[1])}finally{c.__wbindgen_free(a,e,1)}}function we(a,e){const t=_(a,c.__wbindgen_malloc,c.__wbindgen_realloc),n=x,r=c.render_song_samples(t,n,e);if(r[3])throw S(r[2]);var s=se(r[0],r[1]).slice();return c.__wbindgen_free(r[0],r[1]*4,4),s}function xe(a,e,t){const n=_(a,c.__wbindgen_malloc,c.__wbindgen_realloc),r=x,s=_(t,c.__wbindgen_malloc,c.__wbindgen_realloc),i=x,o=c.render_song_samples_with_presets(n,r,e,s,i);if(o[3])throw S(o[2]);var l=se(o[0],o[1]).slice();return c.__wbindgen_free(o[0],o[1]*4,4),l}function ve(a,e){const t=_(a,c.__wbindgen_malloc,c.__wbindgen_realloc),n=x,r=c.render_song_wav(t,n,e);if(r[3])throw S(r[2]);var s=ae(r[0],r[1]).slice();return c.__wbindgen_free(r[0],r[1]*1,1),s}function Ce(a,e,t){const n=_(a,c.__wbindgen_malloc,c.__wbindgen_realloc),r=x,s=_(t,c.__wbindgen_malloc,c.__wbindgen_realloc),i=x,o=c.render_song_wav_with_presets(n,r,e,s,i);if(o[3])throw S(o[2]);var l=ae(o[0],o[1]).slice();return c.__wbindgen_free(o[0],o[1]*1,1),l}function ke(){return{__proto__:null,"./songwalker_core_bg.js":{__proto__:null,__wbg_Error_8c4e43fe74559d73:function(e,t){return Error(U(e,t))},__wbg_String_8f0eb39a4a4c2f66:function(e,t){const n=String(t),r=_(n,c.__wbindgen_malloc,c.__wbindgen_realloc),s=x;ee().setInt32(e+4,s,!0),ee().setInt32(e+0,r,!0)},__wbg___wbindgen_throw_be289d5034ed271b:function(e,t){throw new Error(U(e,t))},__wbg_new_361308b2356cecd0:function(){return new Object},__wbg_new_3eb36ae241fe6f44:function(){return new Array},__wbg_set_3f1d0b984ed272ed:function(e,t,n){e[t]=n},__wbg_set_f43e577aea94465b:function(e,t,n){e[t>>>0]=n},__wbindgen_cast_0000000000000001:function(e){return e},__wbindgen_cast_0000000000000002:function(e,t){return U(e,t)},__wbindgen_cast_0000000000000003:function(e){return BigInt.asUintN(64,e)},__wbindgen_init_externref_table:function(){const e=c.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)}}}}function se(a,e){return a=a>>>0,_e().subarray(a/4,a/4+e)}function ae(a,e){return a=a>>>0,I().subarray(a/1,a/1+e)}let E=null;function ee(){return(E===null||E.buffer.detached===!0||E.buffer.detached===void 0&&E.buffer!==c.memory.buffer)&&(E=new DataView(c.memory.buffer)),E}let R=null;function _e(){return(R===null||R.byteLength===0)&&(R=new Float32Array(c.memory.buffer)),R}function U(a,e){return a=a>>>0,Le(a,e)}let A=null;function I(){return(A===null||A.byteLength===0)&&(A=new Uint8Array(c.memory.buffer)),A}function _(a,e,t){if(t===void 0){const o=T.encode(a),l=e(o.length,1)>>>0;return I().subarray(l,l+o.length).set(o),x=o.length,l}let n=a.length,r=e(n,1)>>>0;const s=I();let i=0;for(;i<n;i++){const o=a.charCodeAt(i);if(o>127)break;s[r+i]=o}if(i!==n){i!==0&&(a=a.slice(i)),r=t(r,n,n=i+a.length*3,1)>>>0;const o=I().subarray(r+i,r+n),l=T.encodeInto(a,o);i+=l.written,r=t(r,n,i,1)>>>0}return x=i,r}function S(a){const e=c.__wbindgen_externrefs.get(a);return c.__externref_table_dealloc(a),e}let O=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});O.decode();const Ee=2146435072;let q=0;function Le(a,e){return q+=e,q>=Ee&&(O=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),O.decode(),q=e),O.decode(I().subarray(a,a+e))}const T=new TextEncoder;"encodeInto"in T||(T.encodeInto=function(a,e){const t=T.encode(a);return e.set(t),{read:a.length,written:t.length}});let x=0,c;function Se(a,e){return c=a.exports,E=null,R=null,A=null,c.__wbindgen_start(),c}async function Pe(a,e){if(typeof Response=="function"&&a instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(a,e)}catch(r){if(a.ok&&t(a.type)&&a.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await a.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(a,e);return n instanceof WebAssembly.Instance?{instance:n,module:a}:n}function t(n){switch(n){case"basic":case"cors":case"default":return!0}return!1}}async function Be(a){if(c!==void 0)return c;a!==void 0&&(Object.getPrototypeOf(a)===Object.prototype?{module_or_path:a}=a:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),a===void 0&&(a=new URL("/assets/songwalker_core_bg-BUGbGuNR.wasm",import.meta.url));const e=ke();(typeof a=="string"||typeof Request=="function"&&a instanceof Request||typeof URL=="function"&&a instanceof URL)&&(a=fetch(a));const{instance:t,module:n}=await Pe(await a,e);return Se(t)}class Re{ctx=null;sourceNode=null;analyser=null;gainNode=null;totalBeats=0;bpm=120;startTime=0;stateTimer=null;playing=!1;onStateChange=null;renderedSamples=null;SAMPLE_RATE=44100;constructor(){}onState(e){this.onStateChange=e}getAnalyser(){return this.analyser}get sampleRate(){return this.SAMPLE_RATE}async playSource(e,t){this.stop(),this.ctx||(this.ctx=new AudioContext({sampleRate:this.SAMPLE_RATE}),this.analyser=this.ctx.createAnalyser(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=.8,this.gainNode=this.ctx.createGain(),this.gainNode.connect(this.analyser),this.analyser.connect(this.ctx.destination)),this.ctx.state==="suspended"&&await this.ctx.resume();const n=t?xe(e,this.SAMPLE_RATE,t):we(e,this.SAMPLE_RATE);if(this.renderedSamples=n,n.length===0){this.emitState();return}this.extractMetadata(e);const r=this.ctx.createBuffer(1,n.length,this.SAMPLE_RATE);r.copyToChannel(n,0),this.sourceNode=this.ctx.createBufferSource(),this.sourceNode.buffer=r,this.sourceNode.connect(this.gainNode),this.playing=!0,this.startTime=this.ctx.currentTime,this.sourceNode.start(0),this.sourceNode.onended=()=>{this.stop()},this.stateTimer=window.setInterval(()=>this.emitState(),50),this.emitState()}stop(){if(this.sourceNode){try{this.sourceNode.stop()}catch{}this.sourceNode.disconnect(),this.sourceNode=null}this.playing=!1,this.stateTimer!==null&&(clearInterval(this.stateTimer),this.stateTimer=null),this.emitState()}exportWav(e,t="song.wav",n){const r=n?Ce(e,this.SAMPLE_RATE,n):ve(e,this.SAMPLE_RATE),s=new Blob([r],{type:"audio/wav"}),i=URL.createObjectURL(s),o=document.createElement("a");o.href=i,o.download=t,o.click(),URL.revokeObjectURL(i)}getCurrentBeat(){return!this.playing||!this.ctx?0:(this.ctx.currentTime-this.startTime)*this.bpm/60}getProgress(){return!this.playing||this.totalBeats<=0?0:Math.min(this.getCurrentBeat()/this.totalBeats,1)}get isPlaying(){return this.playing}get currentBPM(){return this.bpm}get currentTotalBeats(){return this.totalBeats}extractMetadata(e){const t=e.match(/beatsPerMinute\s*=\s*(\d+)/);this.bpm=t?parseInt(t[1],10):120;try{const n=this.sourceNode?.buffer?.duration??0;this.totalBeats=n*this.bpm/60}catch{this.totalBeats=0}}emitState(){this.onStateChange&&this.onStateChange({playing:this.playing,currentBeat:this.getCurrentBeat(),totalBeats:this.totalBeats,bpm:this.bpm})}}class te{constructor(e){this.capacity=e}map=new Map;get(e){const t=this.map.get(e);return t!==void 0&&(this.map.delete(e),this.map.set(e,t)),t}set(e,t){if(this.map.has(e))this.map.delete(e);else if(this.map.size>=this.capacity){const n=this.map.keys().next().value;n!==void 0&&this.map.delete(n)}this.map.set(e,t)}has(e){return this.map.has(e)}clear(){this.map.clear()}get size(){return this.map.size}}function ne(a){return a.replace(/\/[^/]*$/,"")}class Ae{baseUrl;rootIndex=null;loadedLibraries=new Map;enabledLibraries=new Set;loadingLibraries=new Map;presetCache;audioCache;_audioContext=null;constructor(e,t){this.baseUrl=e.replace(/\/+$/,""),this.presetCache=new te(t?.presetCacheSize??256),this.audioCache=new te(t?.audioCacheSize??128)}get hasAudioContext(){return this._audioContext!==null}setAudioContext(e){this._audioContext=e}async loadRootIndex(){if(this.rootIndex)return this.rootIndex;const e=`${this.baseUrl}/index.json`,t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch root index: ${t.status} ${t.statusText}`);return this.rootIndex=await t.json(),this.rootIndex.entries.filter(r=>r.type==="preset").length>0&&(this.loadedLibraries.set("_root",{index:this.rootIndex,baseUrl:this.baseUrl}),this.enabledLibraries.add("_root")),this.rootIndex}async loadIndex(){return this.loadRootIndex()}getRootIndex(){if(!this.rootIndex)throw new Error("Root index not loaded. Call loadRootIndex() first.");return this.rootIndex}getIndex(){return this.getRootIndex()}getAvailableLibraries(){return this.getRootIndex().entries.filter(t=>t.type==="index").map(t=>({name:t.name,path:t.path,description:t.description,presetCount:t.presetCount,loaded:this.loadedLibraries.has(t.name),enabled:this.enabledLibraries.has(t.name)}))}async loadLibrary(e){const t=this.loadedLibraries.get(e);if(t)return t.index;const n=this.loadingLibraries.get(e);if(n)return n;const s=this.getRootIndex().entries.find(o=>o.type==="index"&&o.name===e);if(!s)throw new Error(`Library not found in root index: "${e}"`);const i=this._fetchIndex(s.path,this.baseUrl).then(o=>(this.loadedLibraries.set(e,o),this.loadingLibraries.delete(e),o.index));return this.loadingLibraries.set(e,i),i}async enableLibrary(e){this.loadedLibraries.has(e)||await this.loadLibrary(e),this.enabledLibraries.add(e)}disableLibrary(e){this.enabledLibraries.delete(e)}isLibraryEnabled(e){return this.enabledLibraries.has(e)}isLibraryLoaded(e){return this.loadedLibraries.has(e)}async _fetchIndex(e,t){const n=`${t}/${e}`,r=await fetch(n);if(!r.ok)throw new Error(`Failed to fetch index: ${r.status} ${n}`);return{index:await r.json(),baseUrl:ne(n)}}_getEnabledPresets(){const e=[];for(const[t,{index:n,baseUrl:r}]of this.loadedLibraries)if(this.enabledLibraries.has(t))for(const s of n.entries)s.type==="preset"&&e.push({entry:s,libraryName:t,libraryBaseUrl:r});return e}search(e){let t=this._getEnabledPresets();if(e.library&&(t=t.filter(n=>n.libraryName===e.library)),e.category&&(t=t.filter(n=>n.entry.category===e.category)),e.gmProgram!==void 0&&(t=t.filter(n=>n.entry.gmProgram===e.gmProgram)),e.tags&&e.tags.length>0){const n=new Set(e.tags.map(r=>r.toLowerCase()));t=t.filter(r=>r.entry.tags.some(s=>n.has(s.toLowerCase())))}if(e.name){const n=e.name.toLowerCase();t=t.filter(r=>r.entry.name.toLowerCase().includes(n))}return t.map(n=>n.entry)}fuzzySearch(e,t=20){const n=e.toLowerCase();return this._getEnabledPresets().map(({entry:i})=>{const o=i.name.toLowerCase();let l=0;if(o===n)l=100;else if(o.startsWith(n))l=80;else if(o.includes(n))l=60;else if(i.tags.some(h=>h.toLowerCase().includes(n)))l=40;else{const h=n.split(/\s+/);l=h.filter(p=>o.includes(p)||i.tags.some(g=>g.toLowerCase().includes(p))).length/h.length*30}return{entry:i,score:l}}).filter(i=>i.score>0).sort((i,o)=>o.score-i.score).slice(0,t).map(i=>i.entry)}async loadPreset(e){const t=e.indexOf("/");if(t>0){const r=e.substring(0,t),s=e.substring(t+1);this.enabledLibraries.has(r)||await this.enableLibrary(r);const i=this.search({name:s,library:r});if(i.length>0)return this._loadPresetEntry(i[0],r)}const n=this.search({name:e});if(n.length===0)throw new Error(`Preset not found: "${e}"`);return this._loadPresetEntry(n[0])}async loadPresetByPath(e,t){const n=this.resolvePresetUrl(e,t);return this._fetchPreset(n,e)}async loadPresetByProgram(e){const t=this.search({gmProgram:e});if(t.length===0)throw new Error(`No preset found for GM program ${e}`);return this._loadPresetEntry(t[0])}async _loadPresetEntry(e,t){const n=t??this.findLibraryForEntry(e),r=this.resolvePresetUrl(e.path,n);return this._fetchPreset(r,e.path)}findLibraryForEntry(e){for(const[t,{index:n}]of this.loadedLibraries)if(n.entries.some(r=>r===e))return t}resolvePresetUrl(e,t){if(t){const n=this.loadedLibraries.get(t);if(n)return`${n.baseUrl}/${e}`}return`${this.baseUrl}/${e}`}async _fetchPreset(e,t){if(this.presetCache.has(t))return this.presetCache.get(t);const n=await fetch(e);if(!n.ok)throw new Error(`Failed to fetch preset: ${n.status} ${e}`);const r=await n.json();return this.presetCache.set(t,r),r}async decodeAudio(e,t){const n=this._audioContext;if(!n)throw new Error("AudioContext not set. Call setAudioContext() first.");let r,s;switch(e.type){case"external":{const o=t?`${ne(t)}/${e.path}`:`${this.baseUrl}/${e.path}`;if(r=e.sha256??o,this.audioCache.has(r))return this.audioCache.get(r);const l=await fetch(o);if(!l.ok)throw new Error(`Failed to fetch sample: ${l.status} ${o}`);s=await l.arrayBuffer();break}case"contentAddressed":{if(r=e.sha256,this.audioCache.has(r))return this.audioCache.get(r);const o=`${this.baseUrl}/samples/${e.sha256}.${e.codec}`,l=await fetch(o);if(!l.ok)throw new Error(`Failed to fetch sample: ${l.status} ${o}`);s=await l.arrayBuffer();break}case"inlineFile":{if(r=`inline:${e.data.slice(0,32)}`,this.audioCache.has(r))return this.audioCache.get(r);const o=atob(e.data);s=new ArrayBuffer(o.length);const l=new Uint8Array(s);for(let h=0;h<o.length;h++)l[h]=o.charCodeAt(h);break}case"inlinePcm":{if(r=`pcm:${e.data.slice(0,32)}`,this.audioCache.has(r))return this.audioCache.get(r);const o=atob(e.data),l=new Uint8Array(o.length);for(let p=0;p<o.length;p++)l[p]=o.charCodeAt(p);const h=new Float32Array(l.buffer),u=n.createBuffer(1,h.length,e.sampleRate);return u.copyToChannel(h,0),this.audioCache.set(r,u),u}}const i=await n.decodeAudioData(s);return this.audioCache.set(r,i),i}async decodeSamplerZones(e,t){const n=new Map,r=e.zones.map(async s=>{const i=await this.decodeAudio(s.audio,t);n.set(s,i)});return await Promise.all(r),n}clearCaches(){this.presetCache.clear(),this.audioCache.clear()}get presetCacheSize(){return this.presetCache.size}get audioCacheSize(){return this.audioCache.size}async preloadAll(e){await this.loadRootIndex();const t=new Set;for(const r of e){const s=r.indexOf("/");s>0&&t.add(r.substring(0,s))}await Promise.all(Array.from(t).map(r=>this.enableLibrary(r)));const n=e.map(async r=>{try{const s=await this.loadPreset(r);if(s.node?.type==="sampler"&&s.node.config){const i=this.search({name:r})[0];if(i){const o=this.findLibraryForEntry(i),l=this.resolvePresetUrl(i.path,o);await this.decodeSamplerZones(s.node.config,l)}}}catch(s){console.warn(`[PresetLoader] Failed to preload "${r}":`,s)}});await Promise.all(n)}}const $e={synth:"#89b4fa",sampler:"#a6e3a1",effect:"#fab387",composite:"#cba6f7"};class Ie{container;loader;filteredEntries=[];onSelect=null;searchInput;listEl;statusEl;libraryChipsEl;categoryFilter=null;isOpen=!1;libraries=[];constructor(e,t){this.container=document.createElement("div"),this.container.className="preset-browser",this.container.innerHTML=this.buildHTML(),e.appendChild(this.container),this.loader=t,this.searchInput=this.container.querySelector(".pb-search"),this.listEl=this.container.querySelector(".pb-list"),this.statusEl=this.container.querySelector(".pb-status"),this.libraryChipsEl=this.container.querySelector(".pb-libraries"),this.bindEvents(),this.applyStyles()}onPresetSelect(e){this.onSelect=e}toggle(){this.isOpen=!this.isOpen,this.container.classList.toggle("open",this.isOpen),this.isOpen&&this.libraries.length===0&&this.loadRootIndex()}open(){this.isOpen||this.toggle()}close(){this.isOpen&&this.toggle()}async loadRootIndex(){this.statusEl.textContent="Loading index…";try{await this.loader.loadRootIndex(),this.libraries=this.loader.getAvailableLibraries(),this.renderLibraryChips(),this.statusEl.textContent=`${this.libraries.length} libraries available`;const e=this.libraries.find(t=>t.name==="Built-in");e?await this.toggleLibrary(e.name,!0):this.libraries.length>0&&await this.toggleLibrary(this.libraries[0].name,!0)}catch(e){this.statusEl.textContent=`Error: ${e instanceof Error?e.message:String(e)}`}}renderLibraryChips(){const e=document.createDocumentFragment();for(const t of this.libraries){const n=document.createElement("span");n.className=`pb-lib-chip${t.enabled?" active":""}`,n.dataset.library=t.name,n.title=t.description??t.name;const r=t.name,s=t.presetCount?` (${t.presetCount})`:"";n.textContent=`${r}${s}`,n.addEventListener("click",()=>this.toggleLibrary(t.name)),e.appendChild(n)}this.libraryChipsEl.replaceChildren(e)}async toggleLibrary(e,t){const n=this.libraries.find(s=>s.name===e);if(!n)return;if(t??!n.enabled){const s=this.libraryChipsEl.querySelector(`[data-library="${e}"]`);s&&(s.textContent=`${e} ⏳`);try{await this.loader.enableLibrary(e),n.enabled=!0,n.loaded=!0}catch(i){console.warn(`Failed to load library "${e}":`,i),s&&(s.textContent=`${e} ✗`);return}}else this.loader.disableLibrary(e),n.enabled=!1;this.renderLibraryChips(),this.applyFilter()}applyFilter(){const e=this.searchInput.value.trim();e?this.filteredEntries=this.loader.fuzzySearch(e,100):this.filteredEntries=this.loader.search({}),this.categoryFilter&&(this.filteredEntries=this.filteredEntries.filter(t=>t.category===this.categoryFilter)),this.renderList()}renderList(){const e=document.createDocumentFragment();for(const r of this.filteredEntries.slice(0,200)){const s=document.createElement("div");s.className="pb-item",s.dataset.path=r.path;const i=$e[r.category]??"#cdd6f4";s.innerHTML=`
                <span class="pb-item-dot" style="background:${i}"></span>
                <span class="pb-item-name">${Te(r.name)}</span>
                <span class="pb-item-meta">${r.zoneCount?r.zoneCount+"z":r.category}</span>
            `,s.addEventListener("click",()=>{this.onSelect&&this.onSelect(r)}),e.appendChild(s)}this.listEl.replaceChildren(e);const t=this.filteredEntries.length,n=Math.min(t,200);this.statusEl.textContent=t===n?`${t} presets`:`${n} / ${t} presets`}bindEvents(){this.searchInput.addEventListener("input",()=>this.applyFilter());const e=this.container.querySelectorAll(".pb-chip");e.forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.category;n==="all"||this.categoryFilter===n?(this.categoryFilter=null,e.forEach(r=>r.classList.remove("active")),t.classList.add("active")):(this.categoryFilter=n,e.forEach(r=>r.classList.remove("active")),t.classList.add("active")),this.applyFilter()})})}buildHTML(){return`
            <div class="pb-header">
                <span class="pb-title">Presets</span>
                <button class="pb-close" title="Close">&times;</button>
            </div>
            <div class="pb-libraries"></div>
            <input class="pb-search" type="text" placeholder="Search presets…" />
            <div class="pb-filters">
                <span class="pb-chip active" data-category="all">All</span>
                <span class="pb-chip" data-category="sampler">Sampler</span>
                <span class="pb-chip" data-category="synth">Synth</span>
                <span class="pb-chip" data-category="composite">Composite</span>
                <span class="pb-chip" data-category="effect">Effect</span>
            </div>
            <div class="pb-list"></div>
            <div class="pb-status">Click "Presets" to load</div>
        `}applyStyles(){if(document.getElementById("pb-styles"))return;const e=document.createElement("style");e.id="pb-styles",e.textContent=`
.preset-browser {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 280px;
    background: var(--surface, #181825);
    border-left: 1px solid var(--border, #313244);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.2s ease;
    z-index: 50;
    font-size: 0.85rem;
}
.preset-browser.open {
    transform: translateX(0);
}
.pb-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--border, #313244);
}
.pb-title {
    font-weight: 600;
    color: var(--accent, #89b4fa);
}
.pb-close {
    background: none;
    border: none;
    color: var(--subtext, #a6adc8);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0 4px;
    line-height: 1;
}
.pb-libraries {
    display: flex;
    gap: 4px;
    padding: 0.5rem 0.75rem 0.25rem;
    flex-wrap: wrap;
}
.pb-lib-chip {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    cursor: pointer;
    background: var(--overlay, #11111b);
    border: 1px solid var(--border, #313244);
    color: var(--subtext, #a6adc8);
    user-select: none;
    transition: background 0.15s, color 0.15s;
}
.pb-lib-chip.active {
    background: #45475a;
    color: var(--text, #cdd6f4);
    border-color: var(--accent, #89b4fa);
    font-weight: 600;
}
.pb-lib-chip:hover {
    border-color: var(--accent, #89b4fa);
}
.pb-search {
    margin: 0.5rem 0.75rem;
    padding: 0.35rem 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--border, #313244);
    background: var(--overlay, #11111b);
    color: var(--text, #cdd6f4);
    font-size: 0.8rem;
    outline: none;
}
.pb-search:focus {
    border-color: var(--accent, #89b4fa);
}
.pb-filters {
    display: flex;
    gap: 4px;
    padding: 0 0.75rem 0.5rem;
    flex-wrap: wrap;
}
.pb-chip {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    cursor: pointer;
    background: var(--overlay, #11111b);
    border: 1px solid var(--border, #313244);
    color: var(--subtext, #a6adc8);
    user-select: none;
}
.pb-chip.active {
    background: var(--accent, #89b4fa);
    color: var(--bg, #1e1e2e);
    border-color: var(--accent, #89b4fa);
    font-weight: 600;
}
.pb-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 0.5rem;
}
.pb-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    border-radius: 4px;
    cursor: pointer;
}
.pb-item:hover {
    background: var(--border, #313244);
}
.pb-item-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}
.pb-item-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text, #cdd6f4);
    font-size: 0.8rem;
}
.pb-item-meta {
    font-size: 0.65rem;
    color: var(--subtext, #a6adc8);
    flex-shrink: 0;
}
.pb-status {
    padding: 0.4rem 0.75rem;
    font-size: 0.7rem;
    color: var(--subtext, #a6adc8);
    border-top: 1px solid var(--border, #313244);
}
        `,document.head.appendChild(e)}}function Te(a){const e=document.createElement("span");return e.textContent=a,e.innerHTML}const $="songwalker",Me={comments:{lineComment:"//"},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]},Fe={defaultToken:"",ignoreCase:!1,keywords:["track","const","let","for"],notes:["C","D","E","F","G","A","B"],drums:["Kick","Snare","HiHat","Crash","Ride","Tom","OpenHiHat","ClosedHiHat","Clap","Rimshot"],operators:["=","+","-","*","@","/",".","<",">"],symbols:/[=><!~?:&|+\-*\/\^%@.]+/,tokenizer:{root:[[/\/\/.*$/,"comment"],[/[A-G][b#]?\d+/,"variable.note"],[/\b(Kick|Snare|HiHat|Crash|Ride|Tom|OpenHiHat|ClosedHiHat|Clap|Rimshot)\b/,"variable.drum"],[/\b(track|const|let|for)\b/,"keyword"],[/\b(track)\.([\w.]+)/,["keyword","variable.property"]],[/[a-zA-Z_]\w*(?=\s*[\(*])/,"entity.name.function"],[/[a-zA-Z_]\w*/,"identifier"],[/\d+(\.\d+)?/,"number"],[/"([^"\\]|\\.)*"/,"string"],[/'([^'\\]|\\.)*'/,"string"],[/\/(?![\/\*])([^\/\\]|\\.)*\/[gimsuy]*/,"regexp"],[/\*/,"operator.velocity"],[/@/,"operator.duration"],[/\//,"operator.slash"],[/\.\.?/,"operator.dot"],[/[{}()\[\]]/,"@brackets"],[/[;,]/,"delimiter"]]}},Ne={base:"vs-dark",inherit:!0,rules:[{token:"comment",foreground:"6c7086",fontStyle:"italic"},{token:"keyword",foreground:"cba6f7",fontStyle:"bold"},{token:"variable.note",foreground:"89b4fa",fontStyle:"bold"},{token:"variable.drum",foreground:"fab387",fontStyle:"bold"},{token:"variable.property",foreground:"94e2d5"},{token:"entity.name.function",foreground:"89dceb"},{token:"number",foreground:"fab387"},{token:"string",foreground:"a6e3a1"},{token:"regexp",foreground:"f5c2e7"},{token:"operator.velocity",foreground:"f9e2af"},{token:"operator.duration",foreground:"f9e2af"},{token:"operator.slash",foreground:"6c7086"},{token:"operator.dot",foreground:"f9e2af"},{token:"identifier",foreground:"cdd6f4"},{token:"delimiter",foreground:"6c7086"}],colors:{"editor.background":"#181825","editor.foreground":"#cdd6f4","editor.lineHighlightBackground":"#1e1e2e","editor.selectionBackground":"#45475a","editorCursor.foreground":"#f5e0dc","editorLineNumber.foreground":"#585b70","editorLineNumber.activeForeground":"#a6adc8","editor.inactiveSelectionBackground":"#313244"}},Ue=[{label:"track",kind:1,insertText:"track ${1:name}(${2:params}) {\n	$0\n}",insertTextRules:4,detail:"Define a new track",documentation:"Defines a track that is scheduled when called."},{label:"const",kind:1,insertText:"const ${1:name} = ${0};",insertTextRules:4,detail:"Declare a constant"},{label:"for",kind:1,insertText:"for (let ${1:i} = 0; ${1:i} < ${2:count}; ${1:i}++) {\n	$0\n}",insertTextRules:4,detail:"For loop"},{label:"loadPreset",kind:3,insertText:'loadPreset("${0}")',insertTextRules:4,detail:"Load an instrument preset by name",documentation:"Loads a preset from the catalog. Preset assets are preloaded at compile time."},{label:"Oscillator",kind:3,insertText:"Oscillator({type: '${1|sine,square,sawtooth,triangle|}'})",insertTextRules:4,detail:"Create an oscillator instrument",documentation:"Built-in oscillator preset. Options: type (waveform), attack, decay, sustain, release, detune, mixer."},{label:"track.beatsPerMinute",kind:9,insertText:"track.beatsPerMinute = ${1:120};",insertTextRules:4,detail:"Set the tempo in BPM"},{label:"track.duration",kind:9,insertText:"track.duration = ${1:1/4};",insertTextRules:4,detail:"Set the default step duration (deprecated, use track.noteLength)"},{label:"track.noteLength",kind:9,insertText:"track.noteLength = ${1:1/4};",insertTextRules:4,detail:"Set the default note length"},{label:"track.instrument",kind:9,insertText:"track.instrument = ${1:inst};",insertTextRules:4,detail:"Set the track instrument"},{label:"track.effects",kind:9,insertText:"track.effects = [${0}];",insertTextRules:4,detail:"Set the track effects chain"},{label:"song.endMode",kind:9,insertText:"song.endMode = '${1|gate,release,tail|}';",insertTextRules:4,detail:"Set song end mode: 'gate', 'release', or 'tail'",documentation:"Controls output length. 'gate' = hard cut at last note-off, 'release' = wait for envelope release, 'tail' = wait for effects tail (default)."}];self.MonacoEnvironment={getWorker(a,e){return e==="json"?new Worker(new URL("/assets/json.worker-C838mOW9.js",import.meta.url),{type:"module"}):e==="css"||e==="scss"||e==="less"?new Worker(new URL("/assets/css.worker-NZNbQL3P.js",import.meta.url),{type:"module"}):e==="html"||e==="handlebars"||e==="razor"?new Worker(new URL("/assets/html.worker-eZJr__P7.js",import.meta.url),{type:"module"}):e==="typescript"||e==="javascript"?new Worker(new URL("/assets/ts.worker-BQK-3bkM.js",import.meta.url),{type:"module"}):new Worker(new URL("/assets/editor.worker-C2_AfrSl.js",import.meta.url),{type:"module"})}};const Oe=`// SongWalker Example — songwalker.net
const synth = Oscillator({type: 'triangle'});
track.beatsPerMinute = 140;

riff(synth);

track riff(inst) {
    track.instrument = inst;
    track.noteLength = 1/4;

    C4 /4
    E4 /4
    G4 /4
    C5 /2

    B4 /4
    G4 /4
    E4 /4
    C4 /2

    4
}
`,ie="songwalker_source";function We(){return localStorage.getItem(ie)||Oe}function H(a){localStorage.setItem(ie,a)}function oe(){return"showOpenFilePicker"in window}async function ze(){if(oe())try{const[a]=await window.showOpenFilePicker({types:[{description:"SongWalker files",accept:{"text/plain":[".sw"]}}]});return await(await a.getFile()).text()}catch{return null}else return new Promise(a=>{const e=document.createElement("input");e.type="file",e.accept=".sw,.txt",e.onchange=async()=>{const t=e.files?.[0];a(t?await t.text():null)},e.click()})}async function De(a){if(oe())try{const t=await(await window.showSaveFilePicker({suggestedName:"song.sw",types:[{description:"SongWalker files",accept:{"text/plain":[".sw"]}}]})).createWritable();await t.write(a),await t.close()}catch{}else{const e=new Blob([a],{type:"text/plain"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="song.sw",n.click(),URL.revokeObjectURL(t)}}function je(a,e){const t=e.match(/\[(\d+):(\d+)\]/);if(!t)return;const n=a.getModel();if(!n)return;const r=parseInt(t[1],10),s=parseInt(t[2],10),i=n.getPositionAt(r),o=n.getPositionAt(s);W.setModelMarkers(n,"songwalker",[{severity:be.Error,message:e.replace(/\s*\[\d+:\d+\]/,""),startLineNumber:i.lineNumber,startColumn:i.column,endLineNumber:o.lineNumber,endColumn:o.column}]),a.revealPositionInCenter(i)}function qe(a){const e=a.getModel();e&&W.setModelMarkers(e,"songwalker",[])}function He(){N.register({id:$,extensions:[".sw"]}),N.setLanguageConfiguration($,Me),N.setMonarchTokensProvider($,Fe),W.defineTheme("songwalker-dark",Ne),N.registerCompletionItemProvider($,{provideCompletionItems(a,e){const t=a.getWordUntilPosition(e),n={startLineNumber:e.lineNumber,startColumn:t.startColumn,endLineNumber:e.lineNumber,endColumn:t.endColumn};return{suggestions:Ue.map(r=>({...r,range:n}))}}})}class Ve{peakBarL;peakBarR;peakValueEl;spectrumCanvas;waveformCanvas;spectrumCtx;waveformCtx;rafId=null;player;freqData=null;timeData=null;constructor(e){this.player=e,this.peakBarL=document.getElementById("peak-bar-l"),this.peakBarR=document.getElementById("peak-bar-r"),this.peakValueEl=document.getElementById("peak-value"),this.spectrumCanvas=document.getElementById("spectrum-canvas"),this.waveformCanvas=document.getElementById("waveform-canvas"),this.spectrumCtx=this.spectrumCanvas.getContext("2d"),this.waveformCtx=this.waveformCanvas.getContext("2d")}start(){this.rafId===null&&this.tick()}stop(){this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.peakBarL.style.height="1px",this.peakBarR.style.height="1px",this.peakBarL.className="peak-bar",this.peakBarR.className="peak-bar",this.peakValueEl.textContent="-∞ dB",this.clearCanvas(this.spectrumCtx,this.spectrumCanvas),this.clearCanvas(this.waveformCtx,this.waveformCanvas)}drawWaveformOverview(){const e=this.player.renderedSamples;if(!e||e.length===0)return;const t=this.waveformCanvas,n=this.waveformCtx,r=window.devicePixelRatio||1,s=t.getBoundingClientRect();t.width=s.width*r,t.height=s.height*r,n.scale(r,r);const i=s.width,o=s.height;n.fillStyle="#11111b",n.fillRect(0,0,i,o);const l=Math.max(1,Math.floor(e.length/i));n.beginPath(),n.strokeStyle="#89b4fa",n.lineWidth=1;const h=o/2;for(let u=0;u<i;u++){const p=u*l;let g=0,C=0;for(let b=p;b<p+l&&b<e.length;b++){const y=e[b];y<g&&(g=y),y>C&&(C=y)}n.moveTo(u,h-C*h),n.lineTo(u,h-g*h)}n.stroke(),n.strokeStyle="#313244",n.lineWidth=.5,n.beginPath(),n.moveTo(0,h),n.lineTo(i,h),n.stroke()}tick=()=>{this.rafId=requestAnimationFrame(this.tick);const e=this.player.getAnalyser();!e||!this.player.isPlaying||((!this.freqData||this.freqData.length!==e.frequencyBinCount)&&(this.freqData=new Uint8Array(e.frequencyBinCount),this.timeData=new Uint8Array(e.fftSize)),e.getByteFrequencyData(this.freqData),e.getByteTimeDomainData(this.timeData),this.drawPeak(this.timeData),this.drawSpectrum(this.freqData),this.drawPlayhead())};drawPeak(e){let t=0,n=0;for(let h=0;h<e.length;h++){const u=(e[h]-128)/128;t+=u*u;const p=Math.abs(u);p>n&&(n=p)}const r=Math.sqrt(t/e.length),s=Math.min(r*3*100,100),i=Math.min(n*100,100);this.peakBarL.style.height=`${s}%`,this.peakBarR.style.height=`${i}%`;const o=(h,u)=>{h.className=u>95?"peak-bar clip":u>70?"peak-bar hot":"peak-bar"};o(this.peakBarL,s),o(this.peakBarR,i);const l=n>0?20*Math.log10(n):-1/0;this.peakValueEl.textContent=isFinite(l)?`${l.toFixed(1)} dB`:"-∞ dB"}drawSpectrum(e){const t=this.spectrumCanvas,n=this.spectrumCtx,r=window.devicePixelRatio||1,s=t.getBoundingClientRect();(t.width!==s.width*r||t.height!==s.height*r)&&(t.width=s.width*r,t.height=s.height*r),n.setTransform(r,0,0,r,0,0);const i=s.width,o=s.height;n.fillStyle="#11111b",n.fillRect(0,0,i,o);const l=Math.min(64,e.length),h=i/l;for(let u=0;u<l;u++){const p=Math.floor(Math.pow(e.length,u/l)),g=e[Math.min(p,e.length-1)]/255,C=g*o,b=200+u/l*40;n.fillStyle=`hsl(${b}, 70%, ${50+g*30}%)`,n.fillRect(u*h+.5,o-C,h-1,C)}}drawPlayhead(){const e=this.player.renderedSamples;if(!e||e.length===0)return;const t=this.player.getProgress();if(t<=0)return;const n=this.waveformCanvas,r=this.waveformCtx,s=n.getBoundingClientRect(),i=s.width,o=s.height;this.drawWaveformOverview(),r.fillStyle="rgba(137, 180, 250, 0.08)",r.fillRect(0,0,i*t,o);const l=i*t;r.strokeStyle="#f5e0dc",r.lineWidth=1.5,r.beginPath(),r.moveTo(l,0),r.lineTo(l,o),r.stroke()}clearCanvas(e,t){const n=window.devicePixelRatio||1,r=t.getBoundingClientRect();t.width=r.width*n,t.height=r.height*n,e.setTransform(n,0,0,n,0,0),e.fillStyle="#11111b",e.fillRect(0,0,r.width,r.height)}}class Ge{editor;decorations=[];events=[];player;rafId=null;constructor(e,t){this.editor=e,this.player=t}setEvents(e){this.events=(e?.events??[]).filter(t=>t.kind?.Note&&t.kind.Note.source_start!==void 0)}start(){this.rafId===null&&this.tick()}stop(){this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.clearDecorations()}tick=()=>{if(this.rafId=requestAnimationFrame(this.tick),!this.player.isPlaying)return;const e=this.player.getCurrentBeat(),t=this.editor.getModel();if(!t)return;const n=[];for(const r of this.events){const s=r.kind.Note,i=r.time,o=r.time+s.gate;if(e>=i&&e<o){const l=t.getPositionAt(s.source_start),h=t.getPositionAt(s.source_end);n.push({range:new re(l.lineNumber,l.column,h.lineNumber,h.column),options:{className:"note-playing",inlineClassName:"note-playing-inline"}})}}this.decorations=this.editor.deltaDecorations(this.decorations,n)};clearDecorations(){this.decorations=this.editor.deltaDecorations(this.decorations,[])}}async function Ke(){await Be();const a=document.getElementById("status-version");a&&(a.textContent=`core v${ye()}`);const e=new Re;He();const t=document.createElement("style");t.textContent=`
        .note-playing {
            background-color: rgba(137, 180, 250, 0.15);
            border-radius: 2px;
        }
        .note-playing-inline {
            color: #f5e0dc !important;
            font-weight: bold;
        }
    `,document.head.appendChild(t);const n=document.getElementById("editor-container"),r=W.create(n,{value:We(),language:$,theme:"songwalker-dark",fontSize:14,fontFamily:"'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace",lineNumbers:"on",minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:4,insertSpaces:!0,wordWrap:"off",renderWhitespace:"none",cursorBlinking:"smooth",cursorSmoothCaretAnimation:"on",smoothScrolling:!0,padding:{top:16,bottom:16},bracketPairColorization:{enabled:!0},suggest:{showKeywords:!0,showSnippets:!0}});r.onDidChangeModelContent(()=>{H(r.getValue())});const s=new Ve(e),i=new Ge(r,e),o=document.getElementById("play-btn"),l=document.getElementById("stop-btn"),h=document.getElementById("open-btn"),u=document.getElementById("save-btn"),p=document.getElementById("export-btn"),g=document.getElementById("fullscreen-btn"),C=document.getElementById("preset-btn"),b=document.getElementById("song-select"),y=document.getElementById("status"),V=document.getElementById("status-errors"),G=document.getElementById("status-warnings");function z(){V.textContent="",G.textContent="",qe(r)}function D(d){V.textContent=d,je(r,d)}function M(d){G.textContent=d}function le(d){const f=d?.events??[],m=[];for(const P of f)if(P.kind?.PresetRef?.name){const w=P.kind.PresetRef.name;m.includes(w)||m.push(w)}return m}const v=new Ae("https://clevertree.github.io/songwalker-library"),ce=document.querySelector(".editor-wrapper"),K=new Ie(ce,v);K.onPresetSelect(d=>{const f=r.getPosition();if(f){const m=`// Preset: ${d.name} (${d.path})
`;r.executeEdits("preset-browser",[{range:new re(f.lineNumber,1,f.lineNumber,1),text:m}])}});async function Z(){z();try{const d=r.getValue(),f=Q(d);i.setEvents(f);const m=le(f);let P;if(m.length>0)try{if(M(`Loading ${m.length} preset(s)…`),!v.hasAudioContext){const L=new AudioContext({sampleRate:44100});v.setAudioContext(L)}await v.preloadAll(m);const w=[];for(const L of m)try{const B=await v.loadPreset(L);if(B.node?.type==="sampler"&&B.node.config){const j=B.node.config,F=v.search({name:L})[0],ue=F?v.findLibraryForEntry(F):void 0,fe=F?v.resolvePresetUrl(F.path,ue):void 0,pe=await v.decodeSamplerZones(j,fe),X=[];for(const k of j.zones){const Y=pe.get(k);if(!Y)continue;const me=Y.getChannelData(0);X.push({keyRangeLow:k.keyRange?.low??0,keyRangeHigh:k.keyRange?.high??127,rootNote:k.pitch.rootNote,fineTuneCents:k.pitch.fineTuneCents,sampleRate:k.sampleRate,loopStart:k.loopPoints?.start??null,loopEnd:k.loopPoints?.end??null,samples:Array.from(me)})}w.push({name:L,isDrumKit:j.oneShot??!1,zones:X})}}catch(B){console.warn(`[Player] Failed to load preset "${L}":`,B)}w.length>0?(P=JSON.stringify(w),M(`Loaded ${w.length} preset(s)`)):M("")}catch(w){console.warn("[Player] Preset loading failed, falling back to oscillators:",w),M(`⚠ Preset loading failed: ${w}. Using default oscillator.`)}e.playSource(d,P).then(()=>{s.drawWaveformOverview(),s.start(),i.start()})}catch(d){const f=String(d);D(f)}}async function de(d){try{y.textContent=`Loading ${d}…`;const f=await fetch(`/songs/${d}.sw`);if(!f.ok)throw new Error(`Failed to load ${d}: ${f.status}`);const m=await f.text();r.setValue(m),H(m),y.textContent="Ready",z()}catch(f){y.textContent="Ready",D(String(f))}}b.addEventListener("change",()=>{const d=b.value;d&&(de(d),b.value="")});function he(){z();try{const d=r.getValue();Q(d),e.exportWav(d)}catch(d){const f=String(d);D(f)}}o.addEventListener("click",Z),l.addEventListener("click",()=>{e.stop(),s.stop(),i.stop()}),h.addEventListener("click",async()=>{const d=await ze();d!==null&&(r.setValue(d),H(d))}),u.addEventListener("click",()=>De(r.getValue())),p.addEventListener("click",he),g.addEventListener("click",()=>{document.documentElement.classList.toggle("fullscreen"),setTimeout(()=>r.layout(),100)}),C.addEventListener("click",()=>{K.toggle()}),r.addAction({id:"songwalker.play",label:"Play Song",keybindings:[ge.CtrlCmd|J.Enter],run:()=>Z()}),r.addAction({id:"songwalker.exitFullscreen",label:"Exit Fullscreen",keybindings:[J.Escape],precondition:void 0,run:()=>{document.documentElement.classList.remove("fullscreen"),setTimeout(()=>r.layout(),100)}}),e.onState(d=>{d.playing?y.textContent=`▶ ${d.currentBeat.toFixed(1)} / ${d.totalBeats.toFixed(1)}  @${d.bpm} BPM`:(y.textContent=d.totalBeats>0?`${d.totalBeats.toFixed(1)} beats  @${d.bpm} BPM`:"Ready",s.stop(),i.stop())}),r.focus()}Ke().catch(console.error);

# Copilot Instructions — songwalker-web

## Project Overview

`songwalker-web` is the browser-based editor and player for the SongWalker music programming language. It uses:
- **Monaco Editor** — code editing with custom SongWalker language support
- **Rust WASM** — `songwalker-core` compiled to WebAssembly for compilation and audio rendering
- **Vite** — build tooling and dev server
- **Preset Loader** — loads sampler presets from `songwalker-library`

## Dependency on songwalker-core

This repo does **not** have a Cargo.toml. It consumes pre-built WASM artifacts stored in `src/wasm/`:
- `songwalker_core.js` — JS bindings (generated by wasm-bindgen)
- `songwalker_core.d.ts` — TypeScript declarations
- `songwalker_core_bg.wasm` — compiled WASM binary
- `songwalker_core_bg.wasm.d.ts` — WASM type stubs

### Updating WASM from songwalker-core

When songwalker-core changes, rebuild and re-embed:
```bash
cd /home/ari/dev/songwalker-core
cargo test                          # ensure core tests pass first
wasm-pack build --target web --out-dir /home/ari/dev/songwalker-web/src/wasm
```

This overwrites all files in `src/wasm/`. Commit the updated WASM files in this repo.

## Key Files

- `index.html` — full single-page app (HTML + CSS inline)
- `src/main.ts` — app entry: Monaco setup, play/stop, song loading, preset browser
- `src/player.ts` — `SongPlayer` class: WASM rendering → AudioBuffer playback
- `src/preset-loader.ts` — fetches and resolves sampler presets from library
- `src/preset-browser.ts` — UI overlay for browsing/selecting presets
- `src/sw-language.ts` — Monaco language definition (tokens, completions, theme)

## Version Display

The header shows the core version dynamically via `core_version()` from WASM (not hardcoded).
After `await init()`, main.ts sets the `.version` element text to `core v${core_version()}`.

## Development

```bash
npm install
npm run dev     # starts Vite dev server
npm run build   # production build
```

## Dependency Rules

**Never commit `file:` references** in `package.json` to git. Local `file:../songwalker-js`
references are for development only. Before committing, replace them with the published
npm version (e.g., `"songwalker-js": "^0.1.4"`). `file:` paths break Vercel/GitHub/GitLab
deployments because the sibling repo is not available in CI.

## GitHub Actions

No CI workflows exist yet. If workflows are added, verify them after pushing:
```bash
cd /home/ari/dev/songwalker-web
gh run list --limit 3                # check recent runs
gh run watch <run-id>                # watch a running build
gh run view <run-id> --log-failed    # inspect failures
```

Iterate on any failures until the workflow passes.
